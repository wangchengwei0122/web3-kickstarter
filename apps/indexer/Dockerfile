# ---------- Build Stage ----------
FROM node:20-slim AS builder
WORKDIR /app

ENV CI=true
RUN npm install -g pnpm

# å°†æ•´ä¸ª monorepo å¤åˆ¶è¿›åŽ»
COPY . .

# å®‰è£…æ‰€æœ‰ workspace ä¾èµ–ï¼ˆéžå¸¸å…³é”®ï¼‰
RUN pnpm install

# æ¸…ç†æ—§çš„æž„å»ºäº§ç‰©ï¼ˆç¡®ä¿ä½¿ç”¨æœ€æ–°ä»£ç ï¼‰
RUN rm -rf apps/indexer/dist packages/db/dist

# æž„å»ºå…±äº« db schemaï¼ˆä¾› indexer/api ä½¿ç”¨ï¼‰
RUN pnpm --filter "@packages/db" build

# éªŒè¯ db æž„å»ºäº§ç‰©
RUN test -d packages/db/dist || (echo "âŒ DB build failed" && exit 1)

# æž„å»º indexerï¼ˆå¼ºåˆ¶é‡æ–°æž„å»ºï¼‰
# ç¡®ä¿åœ¨ monorepo æ ¹ç›®å½•æ‰§è¡Œï¼Œä»¥ä¾¿æ­£ç¡®å¤„ç†å·¥ä½œåŒºä¾èµ–
RUN echo "ðŸ”¨ Building indexer from monorepo root..." && \
    pwd && \
    pnpm --filter "@apps/indexer" build && \
    echo "âœ… Build completed"

# éªŒè¯æž„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨ï¼ˆè¯¦ç»†è¾“å‡ºï¼‰
RUN echo "ðŸ“¦ Checking build artifacts..." && \
    pwd && \
    ls -la apps/indexer/ && \
    test -d apps/indexer/dist || (echo "âŒ Build failed: dist directory not found" && exit 1) && \
    echo "ðŸ“ Contents of apps/indexer/dist:" && \
    ls -la apps/indexer/dist/ && \
    test -f apps/indexer/dist/src/index.js || (echo "âŒ Build failed: dist/src/index.js not found" && exit 1) && \
    test -f apps/indexer/dist/abi/index.js || (echo "âŒ Build failed: dist/abi/index.js not found" && exit 1) && \
    echo "âœ… Build artifacts verified: dist/src/index.js and dist/abi/index.js exist"

# ---------- Runtime Stage ----------
FROM node:20-slim AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV NODE_TLS_REJECT_UNAUTHORIZED=0

# å¤åˆ¶æ ¹ node_modulesï¼ˆåŒ…å« .pnpm storeï¼Œä¾›æ‰€æœ‰ workspace ä¾èµ–ä½¿ç”¨ï¼‰
COPY --from=builder /app/node_modules /app/node_modules
# å¤åˆ¶éœ€è¦çš„ packagesï¼ˆç¡®ä¿ workspace è·¯å¾„å­˜åœ¨ï¼‰
COPY --from=builder /app/packages/db /app/packages/db

# å¤åˆ¶ indexer çš„æž„å»ºäº§ç‰©å’Œä¾èµ–ï¼Œä¿æŒä¸Ž builder ç›¸åŒçš„ç›®å½•ç»“æž„
COPY --from=builder /app/apps/indexer /app/apps/indexer

WORKDIR /app/apps/indexer

# éªŒè¯è¿è¡Œæ—¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨
RUN test -f dist/src/index.js || (echo "âŒ Runtime check failed: dist/src/index.js not found" && ls -la . && ls -la dist/ 2>&1 && ls -la dist/src/ 2>&1 || true && exit 1)

CMD ["node", "dist/src/index.js"]
